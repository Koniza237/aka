<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="FARENOUNIVERSITY.jpg" type="image/x-icon">
    <title>Messagerie - Fareno University</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.15/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #background-image {
            background: linear-gradient(135deg, #1e3a8a, #6b7280, #1e3a8a);
            background-size: 200% 200%;
            animation: gradientShift 15s ease-in-out infinite;
            position: fixed;
            inset: 0;
            z-index: -1;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        #root {
            position: relative;
            z-index: 10;
        }
        .chat-container {
            height: calc(100vh - 8rem);
            display: flex;
            flex-direction: column;
        }
        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            margin: 5px 10px;
            border-radius: 15px;
            word-wrap: break-word;
            background-color: #DCF8C6;
            align-self: flex-end;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #F3F4F6;
        }
        body {
            margin: 0;
            font-family: sans-serif;
        }
    </style>
</head>
<body>
    <div id="background-image"></div>
    <div id="root"></div>

    <script type="text/babel">
        function Messaging() {
            const [message, setMessage] = React.useState('');
            const [messages, setMessages] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(false);
            const [error, setError] = React.useState('');
            const chatRef = React.useRef(null);

            React.useEffect(() => {
                fetchMessages();
            }, []);

            React.useEffect(() => {
                if (chatRef.current) {
                    chatRef.current.scrollTop = chatRef.current.scrollHeight;
                }
            }, [messages]);

            const fetchMessages = async () => {
                try {
                    console.log('Envoi de la requÃªte GET http://localhost:3000/api/messages');
                    const response = await fetch('http://localhost:3000/api/messages');
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erreur HTTP ${response.status}: ${errorText}`);
                    }
                    const data = await response.json();
                    // Assign index as the identifier for each message
                    const formattedData = data.map((msg, index) => ({
                        ...msg,
                        index // Use array index as the identifier
                    }));
                    console.log('Messages reÃ§us:', formattedData);
                    setMessages(formattedData);
                    setError('');
                } catch (err) {
                    console.error('Erreur lors du chargement des messages:', err.message);
                    setError('Impossible de charger les messages: ' + err.message);
                }
            };

            const handleSendMessage = async (type) => {
                if (!message.trim()) {
                    setError('Veuillez Ã©crire un message');
                    return;
                }
                setIsLoading(true);
                setError('');
                try {
                    const endpoint = type === 'students' ? 'http://localhost:3000/api/messages-etu' : 'http://localhost:3000/api/messages-ens';
                    console.log(`Envoi du message Ã  ${endpoint}:`, { content: message });
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: message })
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erreur HTTP ${response.status}: ${errorText}`);
                    }
                    const newMessage = await response.json();
                    console.log('Message envoyÃ©:', newMessage);
                    // Add new message with index based on current messages length
                    setMessages(prev => [...prev, { ...newMessage, index: prev.length }]);
                    setMessage('');
                } catch (err) {
                    console.error('Erreur lors de l\'envoi du message:', err.message);
                    setError('Impossible d\'envoyer le message: ' + err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleDeleteMessage = async (index, type) => {
                setIsLoading(true);
                setError('');
                try {
                    const endpoint = `http://localhost:3000/api/messages/${type}/${index}`;
                    console.log(`Suppression du message Ã  ${endpoint}`);
                    const response = await fetch(endpoint, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erreur HTTP ${response.status}: ${errorText}`);
                    }
                    console.log('Message supprimÃ©:', { index, type });
                    // Remove message by index
                    setMessages(prev => prev.filter(msg => msg.index !== index));
                } catch (err) {
                    console.error('Erreur lors de la suppression du message:', err.message);
                    setError('Impossible de supprimer le message: ' + err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    // Ne rien faire ici, l'envoi se fait via les boutons
                }
            };

            return (
                <div className="flex min-h-screen flex-col">
                    <div className="p-4 bg-white border-b border-gray-300 flex justify-between items-center">
                        <h2 className="text-xl font-bold">Messagerie ðŸ’¬</h2>
                        <a href="dashboard.html" className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Retour</a>
                    </div>
                    <div className="flex-1 flex flex-col chat-container">
                        <div className="chat-area" ref={chatRef}>
                            {messages.length > 0 ? (
                                messages.map((msg) => (
                                    <div key={msg.index} className="message-bubble">
                                        <div>{msg.content}</div>
                                        <div className="text-xs text-gray-500 mt-1">
                                            EnvoyÃ© Ã  {msg.type === 'students' ? 'Ã‰tudiants' : 'Enseignants'} le {new Date(msg.timestamp).toLocaleString('fr-FR')}
                                        </div>
                                        <button
                                            className="bg-red-500 text-white px-2 py-1 rounded-lg hover:bg-red-600 text-xs mt-2"
                                            onClick={() => handleDeleteMessage(msg.index, msg.type)}
                                            disabled={isLoading}
                                        >
                                            Supprimer
                                        </button>
                                    </div>
                                ))
                            ) : (
                                <div className="text-center text-gray-500 mt-4">
                                    Aucun message envoyÃ©.
                                </div>
                            )}
                        </div>
                        <div className="p-4 bg-white border-t border-gray-300">
                            <div className="flex items-center space-x-2">
                                <textarea
                                    placeholder="Ã‰crivez un message..."
                                    className="flex-1 border p-2 rounded-lg h-12 resize-none focus:outline-none"
                                    value={message}
                                    onChange={(e) => setMessage(e.target.value)}
                                    onKeyPress={handleKeyPress}
                                />
                                <button
                                    className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600"
                                    onClick={() => handleSendMessage('students')}
                                    disabled={isLoading}
                                >
                                    {isLoading ? 'Envoi...' : 'Ã€ Ã‰tudiants'}
                                </button>
                                <button
                                    className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600"
                                    onClick={() => handleSendMessage('teachers')}
                                    disabled={isLoading}
                                >
                                    {isLoading ? 'Envoi...' : 'Ã€ Enseignants'}
                                </button>
                            </div>
                            {error && (
                                <div className="mt-2 text-red-600 text-sm">{error}</div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<Messaging />, document.getElementById('root'));
    </script>
</body>
</html>